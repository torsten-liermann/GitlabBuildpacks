cache: &global_cache
  key: "build-$CI_PIPELINE_ID"
  paths:
    - "cnb.tgz"
  policy: pull-push

.registry-auth-for-docker:
  before_script:
    - mkdir ~/.docker
    - echo "{\"auths\":{\"$DOCKER_REGISTRY_URL\":{\"username\":\"$DOCKER_REGISTRY_USERNAME\",\"password\":\"$DOCKER_REGISTRY_PASSWORD\"}}}" >> ~/.docker/config.json

.maven-java-environment:
  image: "$CNCF_BUILDER_IMAGE"
  cache:
    <<: *global_cache
    policy: pull
  variables:
    MAVEN_CLI_OPTS: "--no-transfer-progress --batch-mode"
  before_script:
    - | 
      ( cd / && tar xzf $CI_PROJECT_DIR/cnb.tgz )
      export JAVA_HOME='/layers/paketo-buildpacks_bellsoft-liberica/jdk'
      export MAVEN_HOME="$(dirname $(find /layers -name mvn -type f))"
      export PATH="$(pwd):$JAVA_HOME/bin:$MAVEN_HOME/bin:$PATH"

create-java-maven-environment:
  image: "$CNCF_BUILDER_IMAGE"
  stage: .pre
  script:
    - |
      echo -n -this-option-will-break-maven > platform/env/BP_MAVEN_BUILD_ARGUMENTS
      /cnb/lifecycle/creator -platform ./platform $DEBUG_BUILDPACK -app . -cache-image $APP_IMAGE_NAME/paketo-build-cache:latest $APP_IMAGE_NAME:latest || true
      tar czf cnb.tgz /layers